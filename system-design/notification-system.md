# Notification System
消息系统

## 设计范围
- 消息的类型
  - Push 消息
  - SMS 信息
  - 邮件
- 实时性问题
  - 需尽可能的保证实时性，但在高负载的时候可以允许轻度的延迟
- 支持的设备
  - iOS 设备
  - android 设备
  - 笔记本/桌面
- 消息触发机制
  - 可以由客户端应用触发，也可以由服务端主动触发推
- 用户关闭按钮
  - 用户可以选择关闭消息接收
- 消息的数据量
  - 每天百万到千万级别


## 整体设计
![Notification system high-level design](https://cdn.gzhh.tech/2022/10/notification-system-high-level-design.png)

- 服务1-N
  - 表示不同的客户端服务，可以通过消息服务提供的 API 接口发送消息
- 消息服务器
  - 对外提供 API，让客户端服务可以调用发送消息，接口调用需要由权限
  - 对邮件、手机号需要有基础的验证
  - 渲染消息时需要查询数据库或缓存
  - 引入多个 MQ 来并发处理消息数据
- Cache
  - 缓存用户信息、设备信息、消息模版
- DB
  - 存储用户、消息、配置等信息
- Message queues
  - 引入 MQ 避免组件之间的依赖，即避免消息服务与第三方服务之间的依赖；将不同类型的消息推送到不同的 MQ，可以避免受其他类型消息的影响
- Workers
  - 从 MQ 拉取消息并与第三方服务做交互
- 第三方服务
  - iOS、android、email 等平台的消息管理服务
- iOS、android、SMS、email
  - 消息接收设备

## 细节考虑
### 可靠性
- 避免消息丢失
记录日志，并实现消息重传机制
- 消息幂等
在 Workers 做消息唯一验证

### 附加组件
- 消息模版
- 消息设置
- 限流
- 重试机制
- 发送消息的安全性
- 监控队列中的消息
- 事件追踪

### 更新设计
需为以后的扩展及设计调整做适配


## 参考
- [System Design Interview](https://book.douban.com/subject/35246417/)
